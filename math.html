<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“ í•™ìŠµì§€ ìë™ ì±„ì </title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; background: #f5f5f5; }
    .button { font-size: 1.1rem; padding: .75rem 1.5rem; margin: 1rem; cursor: pointer; 
              border:none; border-radius:4px; background:#3182ce; color:#fff; }
    #preview { max-width: 80%; margin: 1rem auto; border: 2px solid #ddd; border-radius:4px; }
    #loading { display:none; color:#555; margin:1rem; }
    #error { display:none; background:#ffe6e6; border:1px solid #feb2b2; color:#c53030;
             max-width:400px; margin:1rem auto; padding:1rem; border-radius:8px; text-align:left; }
    #result { display:none; max-width:800px; margin:2rem auto; text-align:left; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ccc; padding:8px; font-size:0.9rem; }
    th { background:#f0f0f0; }
    .label-cell { background:#fafafa; font-weight:bold; text-align:center; }
    #advice { white-space: pre-wrap; margin-top:1rem; padding:1rem; background:#e6fffa; 
               border:1px solid #b2f5ea; border-radius:8px; text-align:left; }
  </style>
</head>
<body>

  <h1>ğŸ“ í•™ìŠµì§€ ìë™ ì±„ì </h1>
  <input type="file" id="fileUpload" accept="image/*" style="display:none"/>
  <button class="button" onclick="fileUpload.click()">ğŸ“¸ ì—…ë¡œë“œ</button>
  <button class="button" onclick="printResult()">ğŸ–¨ï¸ ì¸ì‡„</button>

  <img id="preview" alt="ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€"/>

  <div id="loading">ì±„ì  ì¤‘â€¦ â³</div>
  <div id="error"><pre id="errorMsg"></pre></div>

  <div id="result">
    <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ grading table -->
    <div id="gradeTableContainer"></div>
    <!-- ì „ì²´ ì ìˆ˜ -->
    <p style="font-size:1.2rem; font-weight:bold; margin-top:1rem;">
      ğŸ¯ ì ìˆ˜: <span id="score"></span>
    </p>
    <!-- AI ì¡°ì–¸ -->
    <div id="advice"></div>
  </div>

  <script>
    const ENDPOINT = 'https://YOUR-REPLIT-URL/grade';
    const fileUpload = document.getElementById('fileUpload');
    const preview    = document.getElementById('preview');
    const loading    = document.getElementById('loading');
    const errorBox   = document.getElementById('error');
    const errorMsg   = document.getElementById('errorMsg');
    const resultBox  = document.getElementById('result');
    const tableCont  = document.getElementById('gradeTableContainer');
    const scoreEl    = document.getElementById('score');
    const adviceEl   = document.getElementById('advice');

    fileUpload.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      doGrade(file);
    });

    async function doGrade(file) {
      // ì´ˆê¸°í™”
      loading.style.display = 'block';
      errorBox.style.display = 'none';
      resultBox.style.display = 'none';
      tableCont.innerHTML = '';
      adviceEl.textContent = '';
      scoreEl.textContent = '';

      const base64 = await new Promise(r => {
        const fr = new FileReader();
        fr.onload = () => r(fr.result.split(',')[1]);
        fr.readAsDataURL(file);
      });

      try {
        const res = await fetch(ENDPOINT, {
          method: 'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ image: base64 })
        });
        const data = await res.json();

        if (!res.ok) throw new Error(data.error || `ì„œë²„ ì˜¤ë¥˜ ${res.status}`);

        // data.questions: [{ no, correct, ans, result:true|false }, â€¦]
        // data.score: "80ì "
        // data.adviceMap: { "3":"íŒíŠ¸â€¦", "7":"â€¦" }

        buildTable(data.questions);
        scoreEl.textContent = data.score;
        adviceEl.textContent = Object.entries(data.adviceMap || {})
                                  .map(([no, txt])=>`ë¬¸ì œ ${no}ë²ˆ: ${txt}`)
                                  .join('\n') || 'â€”';

        resultBox.style.display = 'block';

      } catch(err) {
        errorMsg.textContent = err.message;
        errorBox.style.display = 'block';
      } finally {
        loading.style.display = 'none';
      }
    }

    function buildTable(questions) {
      if (!questions || !questions.length) return;
      const cols = questions.length;
      // í…Œì´ë¸” ìƒì„±
      const tbl = document.createElement('table');
      // í—¤ë” í–‰: ë¹ˆ ì²« ì¹¸ + ë¬¸ì œë²ˆí˜¸
      const tr1 = document.createElement('tr');
      tr1.innerHTML = `<th class="label-cell">í•­ëª©</th>` +
        questions.map(q=>`<th>${q.no}ë²ˆ</th>`).join('');
      tbl.append(tr1);
      // 2í–‰: ì •ë‹µ
      const tr2 = document.createElement('tr');
      tr2.innerHTML = `<th class="label-cell">ì •ë‹µ</th>` +
        questions.map(q=>`<td style="text-align:center">${q.correct}</td>`).join('');
      tbl.append(tr2);
      // 3í–‰: ë‚´ ë‹µ
      const tr3 = document.createElement('tr');
      tr3.innerHTML = `<th class="label-cell">ë‚´ ë‹µ</th>` +
        questions.map(q=>`<td style="text-align:center">${q.ans}</td>`).join('');
      tbl.append(tr3);
      // 4í–‰: ê²°ê³¼
      const tr4 = document.createElement('tr');
      tr4.innerHTML = `<th class="label-cell">ê²°ê³¼</th>` +
        questions.map(q=>{
          return `<td style="text-align:center; color:${q.result?'blue':'red'}">
                    ${q.result?'O':'X'}
                  </td>`;
        }).join('');
      tbl.append(tr4);

      tableCont.append(tbl);
    }

    // ì¸ì‡„
    function printResult() {
      window.print();
    }
  </script>
</body>
</html>
