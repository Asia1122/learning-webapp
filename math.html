<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>📝 학습지 자동 채점</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; background: #f5f5f5; }
    .button { font-size: 1.1rem; padding: .75rem 1.5rem; margin: 1rem; cursor: pointer; 
              border:none; border-radius:4px; background:#3182ce; color:#fff; }
    #preview { max-width: 80%; margin: 1rem auto; border: 2px solid #ddd; border-radius:4px; }
    #loading { display:none; color:#555; margin:1rem; }
    #error { display:none; background:#ffe6e6; border:1px solid #feb2b2; color:#c53030;
             max-width:400px; margin:1rem auto; padding:1rem; border-radius:8px; text-align:left; }
    #result { display:none; max-width:800px; margin:2rem auto; text-align:left; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ccc; padding:8px; font-size:0.9rem; }
    th { background:#f0f0f0; }
    .label-cell { background:#fafafa; font-weight:bold; text-align:center; }
    #advice { white-space: pre-wrap; margin-top:1rem; padding:1rem; background:#e6fffa; 
               border:1px solid #b2f5ea; border-radius:8px; text-align:left; }
  </style>
</head>
<body>

  <h1>📝 학습지 자동 채점</h1>
  <input type="file" id="fileUpload" accept="image/*" style="display:none"/>
  <button class="button" onclick="fileUpload.click()">📸 업로드</button>
  <button class="button" onclick="printResult()">🖨️ 인쇄</button>

  <img id="preview" alt="미리보기 이미지"/>

  <div id="loading">채점 중… ⏳</div>
  <div id="error"><pre id="errorMsg"></pre></div>

  <div id="result">
    <!-- 동적으로 채워질 grading table -->
    <div id="gradeTableContainer"></div>
    <!-- 전체 점수 -->
    <p style="font-size:1.2rem; font-weight:bold; margin-top:1rem;">
      🎯 점수: <span id="score"></span>
    </p>
    <!-- AI 조언 -->
    <div id="advice"></div>
  </div>

  <script>
    const ENDPOINT = 'https://YOUR-REPLIT-URL/grade';
    const fileUpload = document.getElementById('fileUpload');
    const preview    = document.getElementById('preview');
    const loading    = document.getElementById('loading');
    const errorBox   = document.getElementById('error');
    const errorMsg   = document.getElementById('errorMsg');
    const resultBox  = document.getElementById('result');
    const tableCont  = document.getElementById('gradeTableContainer');
    const scoreEl    = document.getElementById('score');
    const adviceEl   = document.getElementById('advice');

    fileUpload.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      doGrade(file);
    });

    async function doGrade(file) {
      // 초기화
      loading.style.display = 'block';
      errorBox.style.display = 'none';
      resultBox.style.display = 'none';
      tableCont.innerHTML = '';
      adviceEl.textContent = '';
      scoreEl.textContent = '';

      const base64 = await new Promise(r => {
        const fr = new FileReader();
        fr.onload = () => r(fr.result.split(',')[1]);
        fr.readAsDataURL(file);
      });

      try {
        const res = await fetch(ENDPOINT, {
          method: 'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ image: base64 })
        });
        const data = await res.json();

        if (!res.ok) throw new Error(data.error || `서버 오류 ${res.status}`);

        // data.questions: [{ no, correct, ans, result:true|false }, …]
        // data.score: "80점"
        // data.adviceMap: { "3":"힌트…", "7":"…" }

        buildTable(data.questions);
        scoreEl.textContent = data.score;
        adviceEl.textContent = Object.entries(data.adviceMap || {})
                                  .map(([no, txt])=>`문제 ${no}번: ${txt}`)
                                  .join('\n') || '—';

        resultBox.style.display = 'block';

      } catch(err) {
        errorMsg.textContent = err.message;
        errorBox.style.display = 'block';
      } finally {
        loading.style.display = 'none';
      }
    }

    function buildTable(questions) {
      if (!questions || !questions.length) return;
      const cols = questions.length;
      // 테이블 생성
      const tbl = document.createElement('table');
      // 헤더 행: 빈 첫 칸 + 문제번호
      const tr1 = document.createElement('tr');
      tr1.innerHTML = `<th class="label-cell">항목</th>` +
        questions.map(q=>`<th>${q.no}번</th>`).join('');
      tbl.append(tr1);
      // 2행: 정답
      const tr2 = document.createElement('tr');
      tr2.innerHTML = `<th class="label-cell">정답</th>` +
        questions.map(q=>`<td style="text-align:center">${q.correct}</td>`).join('');
      tbl.append(tr2);
      // 3행: 내 답
      const tr3 = document.createElement('tr');
      tr3.innerHTML = `<th class="label-cell">내 답</th>` +
        questions.map(q=>`<td style="text-align:center">${q.ans}</td>`).join('');
      tbl.append(tr3);
      // 4행: 결과
      const tr4 = document.createElement('tr');
      tr4.innerHTML = `<th class="label-cell">결과</th>` +
        questions.map(q=>{
          return `<td style="text-align:center; color:${q.result?'blue':'red'}">
                    ${q.result?'O':'X'}
                  </td>`;
        }).join('');
      tbl.append(tr4);

      tableCont.append(tbl);
    }

    // 인쇄
    function printResult() {
      window.print();
    }
  </script>
</body>
</html>
