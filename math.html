<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“ í•™ìŠµì§€ ìë™ ì±„ì </title>

  <!-- í™”ë©´ìš© ìŠ¤íƒ€ì¼ -->
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; background: #f5f5f5; }
    h1 { margin-bottom: 1rem; }
    .button { font-size: 1.1rem; padding: .75rem 1.5rem; margin: .5rem; cursor: pointer; border:none; border-radius:4px; background:#3182ce; color:#fff;}
    #preview { display: none; margin: 1rem auto; border: 2px solid #ddd; border-radius:4px; width: 25%; }
    #loading { display: none; color: #555; margin: 1rem; }
    #error, #result { display: none; margin: 2rem auto; width: 90%; max-width: 600px; text-align: left; padding: 1rem; border-radius:8px;}
    #error { background: #ffe6e6; border: 1px solid #feb2b2; color: #c53030; }
    #result { background: #e6fffa; border: 1px solid #b2f5ea; }
    .section { margin-bottom: 1rem; }
    .section-title { font-weight: bold; margin-bottom: .5rem; }

    .table-wrapper { overflow-x: auto; width: 100%; }
    table.grade-table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
      margin-bottom: 1rem;
    }
    table.grade-table th, table.grade-table td {
      border: 1px solid #ccc;
      padding: 2px;           /* íŒ¨ë”©ì„ ì‘ê²Œ ì¤„ì„ */
      text-align: center;
      word-break: break-all;
      font-size: 0.65rem;     /* í°íŠ¸ í¬ê¸° ì¶•ì†Œ */
    }
    table.grade-table th { background: #f0f0f0; }
    .correct   { color: blue;  font-weight: bold; }
    .incorrect { color: red;   font-weight: bold; }

    #score  { font-size: 1.1rem; font-weight: bold; }
    #advice { white-space: pre-wrap; font-size: 0.75rem; }
  </style>

  <!-- ì¸ì‡„ ì „ìš© ìŠ¤íƒ€ì¼ -->
  <style media="print">
    @page { size: 80mm 80mm; margin: 1mm; }
    /* 1) í™”ë©´ì˜ ëª¨ë“  ìš”ì†Œ ìˆ¨ê¸°ê¸° (ë‹¨, #resultëŠ” ì œì™¸) */
    body > *:not(#result) { display: none !important; }
    /* 2) #result ë³´ì´ê²Œ, ìœ„ì¹˜Â·í¬ê¸° ì§€ì • */
    #result {
      display: block !important;
      position: absolute;
      top: 0; left: 0;
      width: 80mm;
      padding: 1mm;
      box-sizing: border-box;
      /* ë†’ì´ ì œí•œ, overflow ì œê±°í•˜ì—¬ ì¡°ì–¸ê¹Œì§€ ë³´ì´ê²Œ */
    }
    /* 3) í…Œì´ë¸” ë ˆì´ì•„ì›ƒ ë³µì› */
    #result table           { display: table !important; width: 100% !important; }
    #result thead, tbody    { display: table-row-group !important; }
    #result tr              { display: table-row !important; }
    #result th, td          { display: table-cell !important; }
    /* 4) ìë™ ì¶•ì†Œ (Chrome/IE) */
    #result { zoom: 75%; }
  </style>
</head>
<body>

  <h1>ğŸ“ í•™ìŠµì§€ ìë™ ì±„ì </h1>

  <input type="file" accept="image/*" id="fileUpload" style="display:none"/>
  <button class="button" onclick="fileUpload.click()">ğŸ“¸ ì‚¬ì§„ ì°ê¸° ë˜ëŠ” ì—…ë¡œë“œ</button>
  <button class="button" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>

  <img id="preview" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€"/>

  <div id="loading">ì±„ì  ì¤‘â€¦ â³</div>
  <div id="error"><div class="section-title">ğŸš¨ ì—ëŸ¬</div><pre id="errorMsg"></pre></div>

  <div id="result">
    <div class="section">
      <div class="section-title">ğŸ“Š ì±„ì í‘œ</div>
      <div class="table-wrapper" id="gradeTable"></div>
    </div>
    <div class="section">
      <div class="section-title">ğŸ¯ ì ìˆ˜</div>
      <div id="score">â€”</div>
    </div>
    <div class="section">
      <div class="section-title">ğŸ“ AI ì¡°ì–¸</div>
      <div id="advice">â€”</div>
    </div>
  </div>

  <script>
    const ENDPOINT   = 'https://YOUR_REPLIT_URL/grading/grade';
    const fileUpload = document.getElementById('fileUpload');
    const preview    = document.getElementById('preview');
    const loading    = document.getElementById('loading');
    const errorBox   = document.getElementById('error');
    const errorMsg   = document.getElementById('errorMsg');
    const resultBox  = document.getElementById('result');
    const tableWrap  = document.getElementById('gradeTable');
    const scoreEl    = document.getElementById('score');
    const adviceEl   = document.getElementById('advice');

    fileUpload.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      await handleFile(file);
      fileUpload.value = '';
    });

    async function handleFile(file) {
      loading.style.display   = 'block';
      resultBox.style.display = 'none';
      errorBox.style.display  = 'none';
      tableWrap.innerHTML     = '';
      scoreEl.textContent     = 'â€”';
      adviceEl.textContent    = 'â€”';

      const base64 = await new Promise(r => {
        const fr = new FileReader();
        fr.onload = () => r(fr.result.split(',')[1]);
        fr.readAsDataURL(file);
      });

      try {
        const res  = await fetch(ENDPOINT, {
          method: 'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ image: base64 })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || `ì„œë²„ ì˜¤ë¥˜ ${res.status}`);

        buildTable(data.expectedAnswers,
                   data.studentAnswers,
                   data.wrongArr || []);

        scoreEl.textContent = data.score || 'â€”';

        // AI ì¡°ì–¸
        const adv = (data.wrongArr||[]).map(no => {
          const hint = data.adviceMap?.[no] || '';
          return `ë¬¸ì œ ${no}ë²ˆ: ${hint}`;
        }).join('\n') || 'â€”';
        adviceEl.textContent = adv;

        resultBox.style.display = 'block';
      } catch (err) {
        errorMsg.textContent = err.message;
        errorBox.style.display = 'block';
      } finally {
        loading.style.display = 'none';
      }
    }

    function buildTable(expected, studentAns, wrongArr) {
      const qs = Object.keys(expected||{}).map(Number).sort((a,b)=>a-b);
      if (!qs.length) return;
      const tbl = document.createElement('table');
      tbl.className = 'grade-table';

      const mkRow = (label, vals, clsMap={}) => {
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.textContent = label;
        tr.appendChild(th);
        vals.forEach(v => {
          const td = document.createElement('td');
          td.textContent = v;
          if (clsMap[v]) td.classList.add(clsMap[v]);
          tr.appendChild(td);
        });
        return tr;
      };

      const nums = qs;
      const ans  = nums.map(n => expected[n]);
      const stu  = nums.map(n => studentAns[n] ?? 'â€”');
      const res  = nums.map(n => wrongArr.includes(n) ? 'X' : 'O');

      tbl.appendChild(mkRow('ë¬¸ì œë²ˆí˜¸', nums));
      tbl.appendChild(mkRow('ì •ë‹µ',     ans));
      tbl.appendChild(mkRow('ë‚´ ë‹µ',   stu));
      tbl.appendChild(mkRow('ê²°ê³¼',     res, {'O':'correct','X':'incorrect'}));

      tableWrap.appendChild(tbl);
    }
  </script>
</body>
</html>
