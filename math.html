// index.js
require('dotenv').config();
const express = require('express');
const cors    = require('cors');
const fetch   = require('node-fetch');
const AWS     = require('aws-sdk');

// â”€â”€â”€ AWS & DynamoDB ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
AWS.config.update({ region: process.env.AWS_REGION || 'ap-northeast-2' });
const ddb = new AWS.DynamoDB.DocumentClient();

// â”€â”€â”€ í™˜ê²½ë³€ìˆ˜ ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WORKSHEETS_TABLE    = process.env.WORKSHEETS_TABLE;
const CLOVA_URL           = process.env.CLOVA_INVOKE_URL;
const CLOVA_CLIENT_ID     = process.env.CLOVA_CLIENT_ID;
const CLOVA_CLIENT_SECRET = process.env.CLOVA_CLIENT_SECRET;
const OPENAI_KEY          = process.env.OPENAI_API_KEY;
const OPENAI_URL          = 'https://api.openai.com/v1/chat/completions';

if (!WORKSHEETS_TABLE)    throw new Error('í™˜ê²½ë³€ìˆ˜ WORKSHEETS_TABLE ì„¤ì • í•„ìš”');
if (!CLOVA_URL)           throw new Error('í™˜ê²½ë³€ìˆ˜ CLOVA_INVOKE_URL ì„¤ì • í•„ìš”');
if (!CLOVA_CLIENT_ID)     throw new Error('í™˜ê²½ë³€ìˆ˜ CLOVA_CLIENT_ID ì„¤ì • í•„ìš”');
if (!CLOVA_CLIENT_SECRET) throw new Error('í™˜ê²½ë³€ìˆ˜ CLOVA_CLIENT_SECRET ì„¤ì • í•„ìš”');

// â”€â”€â”€ Express ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const app = express();
app.use(cors());
app.use(express.json({ limit: '10mb' }));

// â”€â”€â”€ /grade ì—”ë“œí¬ì¸íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.post('/grade', async (req, res) => {
  try {
    const { image: imageBase64 } = req.body;
    if (!imageBase64) {
      return res.status(400).json({ error: 'ì´ë¯¸ì§€ê°€ ì „ì†¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' });
    }

    // 1) Clova OCR í˜¸ì¶œ
    const ocrRes = await fetch(CLOVA_URL, {
      method: 'POST',
      headers: {
        'Content-Type':           'application/json',
        'X-NCP-APIGW-API-KEY-ID': CLOVA_CLIENT_ID,
        'X-OCR-SECRET':           CLOVA_CLIENT_SECRET
      },
      body: JSON.stringify({
        version:   'V2',
        requestId: `req-${Date.now()}`,
        timestamp: Date.now(),
        images: [
          { format: 'jpg', name: 'sheet', data: imageBase64 }
        ]
      })
    });
    const ocrJson = await ocrRes.json();
    console.log('ðŸ–¼ OCR ì „ì²´ ì‘ë‹µ:', JSON.stringify(ocrJson, null,2));

    const fields = ocrJson.images?.[0]?.fields;
    if (!Array.isArray(fields) || fields.length === 0) {
      return res.status(400).json({ error: 'OCR í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤. í…œí”Œë¦¿ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.' });
    }

    // 2) í•™ìŠµì§€ ì½”ë“œ ì¶”ì¶œ (name === 'code')
    const codeField = fields.find(f => f.name === 'code');
    if (!codeField?.inferText) {
      return res.status(400).json({ error: 'OCRì—ì„œ code í•„ë“œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.' });
    }
    const worksheetCode = codeField.inferText.trim();

    // 3) í•™ìƒ ë‹µì•ˆ í•„ë“œ íŒŒì‹± (a01, a02, â€¦)
    const answerFields = fields
      .filter(f => /^a0*\d+$/.test(f.name))
      .map(f => ({
        no:  parseInt(f.name.slice(1), 10),
        ans: Number((f.inferText || '').replace(/[^0-9\-]/g, ''))
      }));

    if (answerFields.length === 0) {
      return res.status(400).json({ error: 'ë‹µì•ˆ í•„ë“œ(a01, a02, â€¦)ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.' });
    }

    // 4) DynamoDBì—ì„œ ì •ë‹µ&ì¡°ì–¸ ì¡°íšŒ
    const dbRes = await ddb.query({
      TableName: WORKSHEETS_TABLE,
      KeyConditionExpression: 'worksheet_code = :wc',
      ExpressionAttributeValues: { ':wc': worksheetCode }
    }).promise();

    if (!dbRes.Items || dbRes.Items.length === 0) {
      return res.status(404).json({ error: `ì›Œí¬ì‹œíŠ¸ "${worksheetCode}" ì •ë‹µì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.` });
    }

    // 5) ì •ë‹µ ë§µ & ì¡°ì–¸ ë§µ ìƒì„±
    const answerKey = {};
    const adviceKey = {};
    dbRes.Items.forEach(item => {
      answerKey[item.question_number] = item.answer;
      adviceKey[item.question_number] = item.advice || '';
    });

    // 6) ì±„ì  ë° í‹€ë¦° ë¬¸ì œ ìˆ˜ì§‘
    let correct = 0;
    const wrongList = [];
    answerFields.forEach(({ no, ans }) => {
      if (ans === 0 || `${answerKey[no]}` !== `${ans}`) {
        wrongList.push(no);
      } else {
        correct++;
      }
    });
    const total = Object.keys(answerKey).length;
    const scoreText = `${Math.round((correct / total) * 100)}ì  (${correct}/${total})`;

    // 7) DBì—ì„œ ê°€ì ¸ì˜¨ ì¡°ì–¸ë§Œ ì¡°í•©
    let advice = '';
    if (wrongList.length > 0) {
      advice = wrongList
        .map(no => `ë¬¸ì œ ${no}ë²ˆ: ${adviceKey[no]}`)
        .join('\n');
    }

    // 8) ê²°ê³¼ ë°˜í™˜
    return res.json({
      wrong: wrongList.join(', '),
      score: scoreText,
      advice
    });

  } catch (err) {
    console.error('ðŸ’¥ /grade ì˜ˆì™¸:', err);
    return res.status(500).json({ error: err.message });
  }
});

app.listen(3000, () => console.log('âœ… grading server on port 3000'));
