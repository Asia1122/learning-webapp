<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“ í•™ìŠµì§€ ìë™ ì±„ì </title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; background: #f5f5f5; }
    h1 { margin-bottom: 1rem; }
    .button { font-size: 1.1rem; padding: .75rem 1.5rem; margin: .5rem; cursor: pointer; border: none; border-radius:4px; background:#3182ce; color:#fff; }
    #preview { display: none; margin: 1rem auto; border: 2px solid #ddd; border-radius:4px; width: 25%; height: auto; }
    #ocrText { display: none; white-space: pre-wrap; background: #fff; padding: 1rem; margin: 1rem auto; max-width: 80%; border: 1px solid #ccc; text-align: left; }
    #loading { display: none; color: #555; margin: 1rem; }
    #result, #error { display: none; text-align: left; margin: 2rem auto; width: 90%; max-width: 400px; border-radius: 8px; padding: 1rem; }
    #result { background: #e6fffa; border: 1px solid #b2f5ea; }
    #error  { background: #ffe6e6; border: 1px solid #feb2b2; color: #c53030; }
    .section { margin-bottom: 1rem; }
    .section-title { font-weight: bold; margin-bottom: .5rem; }
    /* ì±„ì í‘œ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    table.grade-table { border-collapse: collapse; margin: 0 auto; }
    table.grade-table th, table.grade-table td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      width: 32px;
      text-align: center;
    }
    table.grade-table th { background: #f0f0f0; }
    table.grade-table td.correct { color: blue; font-weight: bold; }
    table.grade-table td.incorrect { color: red; font-weight: bold; }
    /* AI ì¡°ì–¸ ì¤„ë°”ê¿ˆ */
    #advice { white-space: pre-wrap; }

@media print {
  /* 1) í™”ë©´ì˜ ëª¨ë“  ìš”ì†Œ ìˆ¨ê¸°ê¸° */
  body > * { display: none !important; }

  /* 2) #result ì»¨í…Œì´ë„ˆë§Œ ë³´ì´ê²Œ */
  #result { 
    display: block !important;
    position: absolute;
    top: 0; left: 0; width: 100%;
  }

  /* 3) #result ë‚´ë¶€ì˜ ìš”ì†Œë“¤ì€ ì›ë˜ display ì¢…ë¥˜ë¥¼ ìœ ì§€ */
  #result *,
  #result table,
  #result thead,
  #result tbody,
  #result tr,
  #result th,
  #result td {
    display: initial !important;
  }
}

  </style>
</head>
<body>

  <h1>ğŸ“ í•™ìŠµì§€ ìë™ ì±„ì </h1>

  <input type="file" accept="image/*" id="fileUpload" style="display:none"/>
  <button class="button" onclick="fileUpload.click()">ğŸ“¸ ì‚¬ì§„ ì°ê¸° ë˜ëŠ” ì—…ë¡œë“œ</button>
  <button class="button" id="printBtn">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>

  <img id="preview" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€"/>

  <div id="ocrText"></div>

  <div id="loading">ì±„ì  ì¤‘â€¦ â³</div>
  <div id="error"><div class="section-title">ğŸš¨ ì—ëŸ¬ ë©”ì‹œì§€</div><pre id="errorMsg"></pre></div>
  <div id="result">
    <div class="section">
      <div class="section-title">ğŸ“Š ì±„ì í‘œ</div>
      <div id="gradeTable"></div>
    </div>
    <div class="section"><div class="section-title">ğŸ¯ ì ìˆ˜</div><div id="score">â€”</div></div>
    <div class="section"><div class="section-title">ğŸ“ AI ì¡°ì–¸</div><div id="advice">â€”</div></div>
  </div>

  <script>
    const ENDPOINT = 'https://68744ad1-8dba-41d6-9c56-4a5aa4062eb2-00-2w8umvmvho639.sisko.replit.dev/grade';

    const fileUpload = document.getElementById('fileUpload');
    const printBtn   = document.getElementById('printBtn');
    const preview    = document.getElementById('preview');
    const ocrTextDiv = document.getElementById('ocrText');
    const loading    = document.getElementById('loading');
    const resultBox  = document.getElementById('result');
    const errorBox   = document.getElementById('error');
    const errorMsg   = document.getElementById('errorMsg');

    // íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼
    fileUpload.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      handleFile(file);
      // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ì‹œ change ì´ë²¤íŠ¸ê°€ ì•ˆ ì¼ì–´ë‚˜ë¯€ë¡œ ê°’ì„ ë¦¬ì…‹
      fileUpload.value = '';
    });

    // ì¸ì‡„ ë²„íŠ¼
    printBtn.addEventListener('click', () => {
      window.print();
    });

    async function handleFile(file) {
      // ì´ˆê¸°í™”
      loading.style.display    = 'block';
      resultBox.style.display  = 'none';
      errorBox.style.display   = 'none';
      ocrTextDiv.style.display = 'none';
      errorMsg.textContent     = '';

      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result.split(',')[1];
        try {
          const res = await fetch(ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: base64 })
          });
          let data;
          try {
            data = await res.json();
          } catch {
            const txt = await res.text();
            console.error('âš ï¸ JSON íŒŒì‹± ì˜¤ë¥˜, raw:', txt);
            throw new Error('ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
          console.log('ğŸ›°ï¸ ì‘ë‹µ ì „ì²´:', res.status, data);

          if (data.rawText) {
            ocrTextDiv.textContent = data.rawText;
            ocrTextDiv.style.display = 'block';
          }

          if (!res.ok) {
            errorMsg.textContent = data.error || `ì„œë²„ ì˜¤ë¥˜ (${res.status})`;
            errorBox.style.display = 'block';
          } else {
            // 1..10ë²ˆ O/X í…Œì´ë¸” ìƒì„±
            const wrongArr = data.wrong
              ? data.wrong.split(',').map(x => x.trim())
              : [];
            const gradeDiv = document.getElementById('gradeTable');
            gradeDiv.innerHTML = '';
            const tbl = document.createElement('table');
            tbl.className = 'grade-table';
            // header
            const headRow = document.createElement('tr');
            for (let i = 1; i <= 10; i++) {
              const th = document.createElement('th');
              th.textContent = i;
              headRow.appendChild(th);
            }
            tbl.appendChild(headRow);
            // data row
            const dataRow = document.createElement('tr');
            for (let i = 1; i <= 10; i++) {
              const td = document.createElement('td');
              if (wrongArr.includes(String(i))) {
                td.textContent = 'X';
                td.className = 'incorrect';
              } else {
                td.textContent = 'O';
                td.className = 'correct';
              }
              dataRow.appendChild(td);
            }
            tbl.appendChild(dataRow);
            gradeDiv.appendChild(tbl);

            // ì ìˆ˜
            document.getElementById('score').textContent = data.score || '0ì ';
            // AI ì¡°ì–¸
            document.getElementById('advice').textContent = data.advice || 'â€”';
            resultBox.style.display = 'block';
          }
        } catch (err) {
          console.error('ğŸ”´ ì±„ì  ì—ëŸ¬:', err);
          errorMsg.textContent = err.message;
          errorBox.style.display = 'block';
        } finally {
          loading.style.display = 'none';
        }
      };
      reader.readAsDataURL(file);
    }
  </script>

</body>
</html>
