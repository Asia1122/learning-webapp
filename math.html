<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>📝 학습지 자동 채점</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; background: #f5f5f5; }
    h1 { margin-bottom: 1rem; }
    .button { font-size: 1.1rem; padding: .75rem 1.5rem; margin: .5rem; cursor: pointer; border:none; border-radius:4px; background:#3182ce; color:#fff; }
    #preview { display: none; margin: 1rem auto; border: 2px solid #ddd; border-radius:4px; width: 25%; height: auto; }
    #ocrText { display: none; white-space: pre-wrap; background: #fff; padding: 1rem; margin: 1rem auto; max-width: 80%; border: 1px solid #ccc; text-align: left; }
    #loading { display: none; color: #555; margin: 1rem; }
    #result, #error { display: none; text-align: left; margin: 2rem auto; width: 90%; max-width: 600px; border-radius: 8px; padding: 1rem; }
    #result { background: #e6fffa; border: 1px solid #b2f5ea; }
    #error  { background: #ffe6e6; border: 1px solid #feb2b2; color: #c53030; }
    .section { margin-bottom: 1rem; }
    .section-title { font-weight: bold; margin-bottom: .5rem; }

    .table-wrapper { overflow-x: auto; width: 100%; }
    table.grade-table {
      border-collapse: collapse;
      margin: 0 auto;
      width: 100%; max-width: 100%;
      table-layout: fixed;
    }
    table.grade-table th, table.grade-table td {
      border: 1px solid #ccc;
      padding: 6px 4px;
      text-align: center;
      word-break: break-all;
    }
    table.grade-table th { background: #f0f0f0; }
    table.grade-table td.correct  { color: blue;  font-weight: bold; }
    table.grade-table td.incorrect{ color: red;   font-weight: bold; }
    #advice { white-space: pre-wrap; }
  </style>

  <!-- 인쇄 전용 스타일: 오직 #result만 보이고, 강제 축소 적용 -->
  <style media="print">
    @page {
      size: 80mm 80mm;
      margin: 0;
    }
    body * {
      display: none !important;
    }
    #result, #result * {
      display: block !important;
    }
    html, body {
      width: 80mm;
      height: 80mm;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #result {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      overflow: hidden;

      /* 강제 스케일: 이 값을 조정해보세요 (0.7~0.9 사이) */
      -webkit-transform-origin: top left;
      transform-origin: top left;
      -webkit-transform: scale(0.8);
              transform: scale(0.8);

      page-break-after: avoid;
      page-break-before: avoid;
      page-break-inside: avoid;
    }
  </style>
</head>
<body>

  <h1>📝 학습지 자동 채점</h1>

  <input type="file" accept="image/*" id="fileUpload" style="display:none"/>
  <button class="button" onclick="fileUpload.click()">📸 사진 찍기 또는 업로드</button>
  <button class="button" onclick="printResult()">🖨️ 인쇄</button>

  <img id="preview" alt="업로드된 이미지"/>

  <div id="ocrText"></div>

  <div id="loading">채점 중… ⏳</div>
  <div id="error"><div class="section-title">🚨 에러 메시지</div><pre id="errorMsg"></pre></div>

  <div id="result">
    <div class="section">
      <div class="section-title">📊 채점표</div>
      <div class="table-wrapper" id="gradeTable"></div>
    </div>
    <div class="section"><div class="section-title">🎯 점수</div><div id="score">—</div></div>
    <div class="section"><div class="section-title">📝 AI 조언</div><div id="advice">—</div></div>
  </div>

  <script>
    const ENDPOINT = 'https://68744ad1-8dba-41d6-9c56-4a5aa4062eb2-00-2w8umvmvho639.sisko.replit.dev/grading/grade';
    const fileUpload = document.getElementById('fileUpload');
    const preview    = document.getElementById('preview');
    const loading    = document.getElementById('loading');
    const errorBox   = document.getElementById('error');
    const errorMsg   = document.getElementById('errorMsg');
    const resultBox  = document.getElementById('result');
    const tableWrap  = document.getElementById('gradeTable');
    const scoreEl    = document.getElementById('score');
    const adviceEl   = document.getElementById('advice');

    fileUpload.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      await handleFile(file);
      fileUpload.value = '';
    });

    async function handleFile(file) {
      loading.style.display   = 'block';
      resultBox.style.display = 'none';
      errorBox.style.display  = 'none';
      tableWrap.innerHTML     = '';
      scoreEl.textContent     = '—';
      adviceEl.textContent    = '—';

      const base64 = await new Promise(r => {
        const fr = new FileReader();
        fr.onload = ()=> r(fr.result.split(',')[1]);
        fr.readAsDataURL(file);
      });

      try {
        const res  = await fetch(ENDPOINT, {
          method: 'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ image: base64 })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || `서버 오류 ${res.status}`);

        buildTable(data.expectedAnswers, data.studentAnswers, data.wrongArr);
        scoreEl.textContent = data.score || '—';

        const adv = (data.wrongArr||[]).map(no=>{
          const hint = data.adviceMap?.[no] || '';
          return `문제 ${no}번: ${hint}`;
        }).join('\n') || '—';
        adviceEl.textContent = adv;

        resultBox.style.display = 'block';

      } catch(err) {
        errorMsg.textContent = err.message;
        errorBox.style.display = 'block';
      } finally {
        loading.style.display = 'none';
      }
    }

    function buildTable(expected, studentAns, wrongArr) {
      const qs = Object.keys(expected||{}).map(x=>Number(x)).sort((a,b)=>a - b);
      if (!qs.length) return;
      const tbl = document.createElement('table');
      tbl.className = 'grade-table';

      const tr1 = document.createElement('tr');
      tr1.appendChild(labelCell('문제번호'));
      qs.forEach(no => tr1.appendChild(dataCell(no)));
      tbl.appendChild(tr1);

      const tr2 = document.createElement('tr');
      tr2.appendChild(labelCell('정답'));
      qs.forEach(no => tr2.appendChild(dataCell(expected[no])));
      tbl.appendChild(tr2);

      const tr3 = document.createElement('tr');
      tr3.appendChild(labelCell('내 답'));
      qs.forEach(no => tr3.appendChild(dataCell(studentAns[no] ?? '—')));
      tbl.appendChild(tr3);

      const tr4 = document.createElement('tr');
      tr4.appendChild(labelCell('결과'));
      qs.forEach(no => {
        const ok = !(wrongArr||[]).includes(no);
        const td = dataCell(ok ? 'O' : 'X');
        td.className = ok ? 'correct' : 'incorrect';
        tr4.appendChild(td);
      });
      tbl.appendChild(tr4);

      tableWrap.appendChild(tbl);
    }

    function labelCell(t) {
      const th = document.createElement('th');
      th.textContent = t;
      return th;
    }
    function dataCell(txt) {
      const td = document.createElement('td');
      td.textContent = txt;
      return td;
    }

    function printResult() {
      window.print();
    }
  </script>

</body>
</html>
