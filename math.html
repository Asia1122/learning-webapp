// index.js
require('dotenv').config();
const express = require('express');
const cors    = require('cors');
const fetch   = require('node-fetch');
const AWS     = require('aws-sdk');

// ─── AWS & DynamoDB 설정 ─────────────────────────────────
AWS.config.update({ region: process.env.AWS_REGION || 'ap-northeast-2' });
const ddb = new AWS.DynamoDB.DocumentClient();

// ─── 환경변수 로드 ─────────────────────────────────────────
const WORKSHEETS_TABLE    = process.env.WORKSHEETS_TABLE;      // DynamoDB 테이블 이름
const CLOVA_URL           = process.env.CLOVA_INVOKE_URL;      // Naver Clova OCR 엔드포인트
const CLOVA_CLIENT_ID     = process.env.CLOVA_CLIENT_ID;       // NCP API ID
const CLOVA_CLIENT_SECRET = process.env.CLOVA_CLIENT_SECRET;   // NCP API Secret

if (!WORKSHEETS_TABLE)    throw new Error('환경변수 WORKSHEETS_TABLE이 설정되지 않았습니다.');
if (!CLOVA_URL)           throw new Error('환경변수 CLOVA_INVOKE_URL이 설정되지 않았습니다.');
if (!CLOVA_CLIENT_ID)     throw new Error('환경변수 CLOVA_CLIENT_ID가 설정되지 않았습니다.');
if (!CLOVA_CLIENT_SECRET) throw new Error('환경변수 CLOVA_CLIENT_SECRET이 설정되지 않았습니다.');

// ─── Express 앱 설정 ───────────────────────────────────
const app = express();
app.use(cors());
app.use(express.json({ limit: '10mb' }));

// ─── POST /grade: 이미지 → 채점 응답 ─────────────────────
app.post('/grade', async (req, res) => {
  try {
    const { image: imageBase64 } = req.body;
    if (!imageBase64) {
      return res.status(400).json({ error: '이미지 데이터가 전송되지 않았습니다.' });
    }

    // 1) Clova OCR 호출
    const ocrRes = await fetch(CLOVA_URL, {
      method: 'POST',
      headers: {
        'Content-Type':           'application/json',
        'X-NCP-APIGW-API-KEY-ID': CLOVA_CLIENT_ID,
        'X-OCR-SECRET':           CLOVA_CLIENT_SECRET
      },
      body: JSON.stringify({
        version:   'V2',
        requestId: `req-${Date.now()}`,
        timestamp: Date.now(),
        images: [{ format: 'jpg', name: 'sheet', data: imageBase64 }]
      })
    });
    const ocrJson = await ocrRes.json();
    console.log('🖼 OCR 응답:', JSON.stringify(ocrJson, null, 2));

    const fields = ocrJson.images?.[0]?.fields;
    if (!Array.isArray(fields) || fields.length === 0) {
      return res.status(400).json({ error: 'OCR 데이터가 올바르지 않습니다.' });
    }

    // 2) 워크시트 코드 추출 (field.name === 'code')
    const codeField = fields.find(f => f.name === 'code');
    if (!codeField?.inferText) {
      return res.status(400).json({ error: '학습지 코드를 인식할 수 없습니다.' });
    }
    const worksheetCode = codeField.inferText.trim();
    console.log('▶ worksheetCode:', worksheetCode);

    // 3) 학생 답안 필드 파싱 (a01, a02, …)
    const answerFields = fields
      .filter(f => /^a0*\d+$/.test(f.name))
      .map(f => ({
        no:  parseInt(f.name.slice(1), 10),
        ans: Number((f.inferText || '').replace(/[^0-9\-]/g, ''))
      }));
    console.log('▶ OCR로 읽은 답안들:', answerFields);

    if (answerFields.length === 0) {
      return res.status(400).json({ error: '답안 필드를 찾지 못했습니다.' });
    }

    // 4) DynamoDB에서 정답 및 조언 조회
    const dbRes = await ddb.query({
      TableName: WORKSHEETS_TABLE,
      KeyConditionExpression: 'worksheet_code = :wc',
      ExpressionAttributeValues: { ':wc': worksheetCode }
    }).promise();
    console.log('▶ DynamoDB 조회 결과:', dbRes.Items);

    if (!dbRes.Items || dbRes.Items.length === 0) {
      return res.status(404).json({ error: '해당 워크시트의 정답 데이터를 찾을 수 없습니다.' });
    }

    // 5) 정답 맵 및 조언 맵 생성
    const answerKey = {};
    const adviceKey = {};
    dbRes.Items.forEach(item => {
      // 테이블 스키마에 맞춰 속성명을 조정하세요
      // 예: item.question_number, item.answer, item.advice
      answerKey[item.question_number] = item.answer;
      adviceKey[item.question_number] = item.advice || '';
    });
    console.log('▶ 정답 맵:', answerKey);
    console.log('▶ 조언 맵:', adviceKey);

    // 6) 채점 로직: 맞힌 개수, 틀린 문제 리스트
    let correctCount = 0;
    const wrongList = [];
    answerFields.forEach(({ no, ans }) => {
      const correctAns = answerKey[no];
      if (!correctAns || ans === 0 || String(ans) !== String(correctAns)) {
        wrongList.push(no);
      } else {
        correctCount++;
      }
    });
    const total = Object.keys(answerKey).length;
    const scoreText = `${Math.round((correctCount / total) * 100)}점 (${correctCount}/${total})`;
    console.log('✅ 채점 완료:', scoreText, '틀린 문제:', wrongList);

    // 7) DB에서 가져온 조언만 조합
    let advice = '';
    if (wrongList.length > 0) {
      advice = wrongList
        .map(no => `문제 ${no}번: ${adviceKey[no]}`)
        .join('\n');
    }

    // 8) 최종 응답
    return res.json({
      wrong:  wrongList.join(', '),
      score:  scoreText,
      advice
    });

  } catch (err) {
    console.error('💥 /grade 에러:', err);
    return res.status(500).json({ error: err.message });
  }
});

// ─── 서버 시작 ───────────────────────────────────────────
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`✅ Grading server running on port ${PORT}`);
});
